trigger:
  - master

variables:
  buildConfiguration: 'Release'
  outputDirectory: '$(build.binariesDirectory)/$(buildConfiguration)'

jobs:
- job: Titan
  pool:
    vmImage: 'macOS-latest'
  steps:
  - template: build-pipeline.yml
    parameters:
      flavour: 'Titan'

- job: OurStory
  pool:
    vmImage: 'macOS-latest'
  steps:
  - template: build-pipeline.yml
    parameters:
      flavour: 'OurStory'

- job: Release
  dependsOn:
    - Titan
    - OurStory
  steps:
    - download: current
    - task: CopyFiles@2
      inputs:
        contents: $(Build.ArtifactStagingDirectory)/*.apk
        targetFolder: $(Build.SourcesDirectory)
    - task: AndroidSigning@3
      inputs:
        apkFiles: '**/*.apk'
        zipalign: true
        jarsign: true
        apksignerKeystoreFile: 'ourstory.keystore'
        apksignerKeystorePassword: '$(KeystorePassword)'
        apksignerKeystoreAlias: 'ourstory'
        apksignerKeyPassword: '$(KeystorePassword)'
    - task: GitHubRelease@0
      inputs:
        gitHubConnection: 'OurStory GitHub'
        repositoryName: 'our-story-media/ourstory-android'
        action: 'create'
        title: 'Our Story Application'
        addChangeLog: false
        assets: '**/*.apk'